import React, { useMemo, useRef, useState, useEffect, useCallback } from 'react';
import {
  MaterialReactTable,
  useMaterialReactTable,
  type MRT_ColumnDef,
  type MRT_SortingState,
  type MRT_RowVirtualizer,
} from 'material-react-table';
import type { Vulnerability } from '../types/vulnerability';
import { Button, Chip, TextField, Box, Switch, FormControlLabel, Typography } from '@mui/material';

export interface VulnerabilityTableProps {
  vulnerabilities: Vulnerability[];
}

const VulnerabilityTable: React.FC<VulnerabilityTableProps> = ({ vulnerabilities }) => {
  const [sorting, setSorting] = useState<MRT_SortingState>([]);
  const [dismissed, setDismissed] = useState<Set<string>>(new Set());
  const [globalFilter, setGlobalFilter] = useState('');
  const [showDismissed, setShowDismissed] = useState(false);
  const rowVirtualizerInstanceRef = useRef<MRT_RowVirtualizer>(null);

  useEffect(() => {
    // Scroll to the top of the table when the sorting changes
    try {
      rowVirtualizerInstanceRef.current?.scrollToIndex?.(0);
    } catch (error) {
      // ignore
    }
  }, [sorting]);

  const handleDismiss = useCallback((vuln: Vulnerability) => {
    setDismissed(prev => new Set(prev).add(`${vuln.cveId}-${vuln.package}`));
  }, []);

  const handleUndismiss = useCallback((vuln: Vulnerability) => {
    setDismissed(prev => {
      const newSet = new Set(prev);
      newSet.delete(`${vuln.cveId}-${vuln.package}`);
      return newSet;
    });
  }, []);

  // Add isDismissed property for each vulnerability
  const dataWithDismissed = useMemo(() => {
    return vulnerabilities.map(vuln => ({ ...vuln, isDismissed: dismissed.has(`${vuln.cveId}-${vuln.package}`) }));
  }, [vulnerabilities, dismissed]);

  // Filter data based on showDismissed toggle
  const filteredData = useMemo(() => {
    if (showDismissed) return dataWithDismissed.filter(vuln => vuln.isDismissed);
    return dataWithDismissed.filter(vuln => !vuln.isDismissed);
  }, [dataWithDismissed, showDismissed]);

  const severityOrder: Record<string, number> = {
    critical: 0,
    high: 1,
    medium: 2,
    low: 3,
    unknown: 4,
  };

  const columns = useMemo<MRT_ColumnDef<Vulnerability & { isDismissed: boolean }>[]>(
    () => [
      {
        accessorKey: 'cveId',
        header: 'CVE',
        size: 120,
      },
      {
        accessorKey: 'severity',
        header: 'Severity',
        size: 100,
        Cell: ({ cell }) => (
          <Chip
            label={cell.getValue<string>().charAt(0).toUpperCase() + cell.getValue<string>().slice(1)}
            color={
              cell.getValue<string>().toLowerCase() === 'critical' ? 'error' :
              cell.getValue<string>().toLowerCase() === 'high' ? 'warning' :
              cell.getValue<string>().toLowerCase() === 'medium' ? 'info' :
              cell.getValue<string>().toLowerCase() === 'low' ? 'success' :
              'default'
            }
            size="small"
            sx={{ fontWeight: 500 }}
          />
        ),
        sortingFn: (rowA, rowB, columnId) => {
          const a = (rowA.getValue<string>(columnId) || '').toLowerCase();
          const b = (rowB.getValue<string>(columnId) || '').toLowerCase();
          return (severityOrder[a] ?? 99) - (severityOrder[b] ?? 99);
        },
      },
      {
        accessorKey: 'package',
        header: 'Package',
        size: 140,
      },
      {
        accessorKey: 'version',
        header: 'Version',
        size: 100,
      },
      {
        accessorKey: 'exploited',
        header: 'Exploited',
        size: 100,
        Cell: ({ cell }) => (
          cell.getValue<boolean>() ? (
            <Chip label="True" color="error" size="small" />
          ) : (
            <Chip label="False" color="default" size="small" />
          )
        ),
      },
      {
        accessorKey: 'actions',
        header: 'Actions',
        size: 120,
        Cell: ({ row }) => {
          const vuln = row.original;
          return vuln.isDismissed ? (
            <Button
              variant="outlined"
              color="secondary"
              size="small"
              onClick={() => handleUndismiss(vuln)}
            >
              Undo Dismiss
            </Button>
          ) : (
            <Button
              variant="contained"
              size="small"
              onClick={() => handleDismiss(vuln)}
              sx={{ backgroundColor: 'black', color: 'white', '&:hover': { backgroundColor: '#222' } }}
            >
              Dismiss
            </Button>
          );
        },
        enableSorting: false,
      },
    ],
    [handleDismiss, handleUndismiss],
  );

  const table = useMaterialReactTable({
    columns,
    data: filteredData,
    enableBottomToolbar: false,
    enableGlobalFilterModes: true,
    enablePagination: false,
    enableRowNumbers: true,
    enableRowVirtualization: true,
    muiTableContainerProps: { sx: { maxHeight: '600px' } },
    onSortingChange: setSorting,
    state: { isLoading: false, sorting, globalFilter },
    onGlobalFilterChange: setGlobalFilter,
    rowVirtualizerInstanceRef,
    rowVirtualizerOptions: { overscan: 5 },
    muiTableBodyRowProps: ({ row }) => {
      const isDismissed = row.original.isDismissed;
      return isDismissed
        ? {
            sx: {
              backgroundColor: '#fff0f0',
              opacity: 0.5,
              transition: 'background 0.2s',
            },
          }
        : {};
    },
  });

  return (
    <Box>
      <Typography variant="h5" fontWeight={700} sx={{ mb: 2 }}>
        CVE Tracker
      </Typography>
      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
        <TextField
          label="Search vulnerabilities"
          variant="outlined"
          value={globalFilter}
          onChange={e => setGlobalFilter(e.target.value)}
          size="small"
          sx={{ width: 320 }}
        />
        <FormControlLabel
          control={
            <Switch
              checked={showDismissed}
              onChange={(_, checked) => setShowDismissed(checked)}
              color="primary"
            />
          }
          label="Show Only Dismissed"
        />
      </Box>
      <MaterialReactTable table={table} />
    </Box>
  );
};

export default VulnerabilityTable; 